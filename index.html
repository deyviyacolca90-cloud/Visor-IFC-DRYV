<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor IFC - DRYV</title>
    
    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #171717; color: #f3f4f6; font-family: sans-serif; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        .sidebar { z-index: 20; transition: transform 0.3s ease; }
        .sidebar.closed { transform: translateX(-100%); }
        #debug-console {
            position: absolute; top: 0; right: 0; width: 50%; max-height: 100px;
            background: rgba(0,0,0,0.5); color: #0f0; font-size: 10px;
            overflow-y: auto; z-index: 100; pointer-events: none; display: none;
            padding: 4px; font-family: monospace;
        }
        .debug-error { color: #f55; }
    </style>

    <!-- IMPORT MAP: Usamos esm.sh que es mucho más fiable para módulos en navegador -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.155.0",
                "three/examples/jsm/controls/OrbitControls.js": "https://esm.sh/three@0.155.0/examples/jsm/controls/OrbitControls.js",
                "web-ifc-three": "https://esm.sh/web-ifc-three@0.0.126?deps=three@0.155.0,web-ifc@0.0.44",
                "web-ifc": "https://esm.sh/web-ifc@0.0.44"
            }
        }
    </script>
</head>
<body>

    <!-- Debug Console -->
    <div id="debug-console"></div>

    <!-- UI Overlay -->
    <div id="app-ui" class="absolute inset-0 pointer-events-none z-10 flex flex-col h-full">
        
        <!-- Botón Menú Móvil -->
        <button id="menu-btn" class="pointer-events-auto absolute top-4 left-4 z-30 bg-neutral-800 p-2 rounded text-white shadow-lg lg:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        </button>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar pointer-events-auto bg-neutral-800 border-r border-neutral-700 w-[85vw] sm:w-80 h-full flex flex-col absolute lg:relative shadow-2xl">
            <!-- Header -->
            <div class="p-4 border-b border-neutral-700 flex justify-between items-center bg-neutral-900/50">
                <h1 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m16.02 12 5.48 3.13a1 1 0 0 1 .49.87v5a1 1 0 0 1-1 1h-16a1 1 0 0 1-1-1v-5a1 1 0 0 1 .49-.87l5.48-3.13"/><path d="M16 12V7a4 4 0 0 0-8 0v5"/><path d="M12 21v-9"/></svg>
                    Visor IFC - DRYV
                </h1>
                <button id="close-sidebar" class="lg:hidden p-1 hover:bg-neutral-700 rounded text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                
                <!-- Carga -->
                <div class="space-y-3">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Proyecto</h2>
                    
                    <label class="block w-full cursor-pointer bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        <span class="font-medium">Abrir Archivo IFC</span>
                        <input type="file" id="file-input" accept=".ifc" class="hidden" />
                    </label>

                    <button id="load-demo" class="w-full bg-neutral-700 hover:bg-neutral-600 text-gray-300 py-2 rounded-lg flex items-center justify-center gap-2 text-xs border border-neutral-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                        Cargar Ejemplo
                    </button>

                    <div id="loading-bar" class="hidden w-full bg-neutral-700 rounded-full h-2 overflow-hidden">
                        <div class="bg-blue-500 h-full w-full animate-pulse"></div>
                    </div>
                    <div id="error-msg" class="hidden text-red-400 text-xs bg-red-900/20 p-3 rounded border border-red-800/50 break-words font-mono"></div>
                </div>

                <hr class="border-neutral-700" />

                <!-- Herramientas -->
                <div class="space-y-3">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Herramientas</h2>
                    <div class="grid grid-cols-5 gap-1">
                        <button class="tool-btn bg-blue-600/20 text-blue-400 border border-blue-600/50 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform" data-tool="view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/></svg>
                            <span class="text-[9px]">Nav</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-400 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform" data-tool="select">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <span class="text-[9px]">Info</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-400 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform" data-tool="measure">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>
                            <span class="text-[9px]">Medir</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-400 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform" data-tool="section">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>
                            <span class="text-[9px]">Cortes</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-400 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform" data-tool="surface-cut">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg>
                            <span class="text-[9px]">Cara</span>
                        </button>
                    </div>
                    <div id="tool-instruction" class="text-xs text-gray-400 bg-black/20 p-2 rounded text-center italic border border-white/5">
                        Arrastra para rotar.
                    </div>
                </div>

                <hr class="border-neutral-700" />

                <!-- PANEL: PROPIEDADES -->
                <div id="properties-panel" class="hidden space-y-3 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-bold text-green-400 uppercase tracking-wide">Propiedades</h2>
                        <button id="clear-selection" class="text-gray-500 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                    </div>
                    <div id="props-basic" class="bg-neutral-900/50 rounded p-3 text-xs space-y-2 font-mono border border-neutral-700/50"></div>
                    <div class="space-y-1">
                        <h3 class="text-xs font-bold text-yellow-500 uppercase mt-2">Dimensiones</h3>
                        <div id="props-quantities" class="bg-neutral-900/50 rounded p-3 text-xs space-y-2 font-mono border border-neutral-700/50"></div>
                    </div>
                    <details class="group">
                        <summary class="text-xs font-bold text-gray-500 uppercase cursor-pointer list-none flex justify-between items-center bg-neutral-900/30 p-2 rounded">
                            <span>Datos Crudos</span>
                            <span class="text-[10px]">▼</span>
                        </summary>
                        <div id="props-raw" class="bg-black/40 rounded p-2 text-[10px] font-mono max-h-32 overflow-auto text-gray-400 whitespace-pre-wrap mt-1"></div>
                    </details>
                </div>

                <!-- PANEL: SECCIONES -->
                <div id="sections-panel" class="hidden space-y-3 animate-in fade-in slide-in-from-right-4 duration-300">
                    <h2 class="text-sm font-bold text-yellow-500 uppercase tracking-wide">Configurar Cortes</h2>
                    <div id="sections-controls" class="bg-neutral-900/50 rounded p-3 space-y-4 border border-neutral-700/50"></div>
                </div>

                <!-- PANEL: MEDICIONES -->
                <div id="measure-panel" class="hidden space-y-3">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Mediciones</h2>
                        <button id="clear-measures" class="text-xs text-red-400 hover:text-red-300">Borrar todo</button>
                    </div>
                    <ul id="measure-list" class="space-y-1 max-h-32 overflow-y-auto"></ul>
                </div>

            </div>
            
            <!-- Footer -->
            <div class="p-3 border-t border-neutral-700 text-[10px] text-neutral-500 text-center">
                Three.js v0.155 &bull; IFCLoader
            </div>
        </div>
    </div>

    <!-- Canvas 3D -->
    <div id="canvas-container"></div>

    <!-- Status Bar Flotante -->
    <div id="status-bar-container" class="absolute bottom-6 left-1/2 -translate-x-1/2 z-20 transition-all duration-300">
        <div id="status-bar" class="bg-neutral-900/90 backdrop-blur-md px-4 py-2 rounded-full text-xs text-gray-300 border border-white/10 shadow-xl flex items-center gap-2 whitespace-nowrap">
            <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
            Cargando motor gráfico...
        </div>
    </div>

    <!-- LOGICA APP -->
    <script type="module">
        // --------------------------------------------------------------------------------
        // GESTIÓN DE ERRORES
        // --------------------------------------------------------------------------------
        const debugConsole = document.getElementById('debug-console');
        const statusBar = document.getElementById('status-bar');
        
        function logDebug(msg, isError = false) {
            console.log(msg);
            if (isError) {
                console.error(msg);
                debugConsole.style.display = 'block';
                debugConsole.innerHTML += `<div class="debug-error">ERROR: ${msg}</div>`;
                statusBar.innerText = "Error: Ver detalles";
                statusBar.classList.add("text-red-400");
                document.getElementById('error-msg').innerText = msg;
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        window.onerror = function(message, source, lineno, colno, error) {
            logDebug(`${message} at ${lineno}:${colno}`, true);
        };

        // --------------------------------------------------------------------------------
        // IMPORTACIONES Y CONFIGURACIÓN
        // --------------------------------------------------------------------------------
        
        let THREE, OrbitControls, IFCLoader;
        let clippingPlanes = [];

        async function initApp() {
            try {
                statusBar.innerText = "Descargando librerías...";
                
                // Carga dinámica usando el importmap definido arriba
                THREE = await import('three');
                const controlsModule = await import('three/examples/jsm/controls/OrbitControls.js');
                OrbitControls = controlsModule.OrbitControls;
                const ifcModule = await import('web-ifc-three');
                IFCLoader = ifcModule.IFCLoader;

                statusBar.innerText = "Motor listo. Carga un modelo.";
                initThreeJS();
            } catch (e) {
                logDebug("Fallo conexión librerías: " + e.message, true);
            }
        }

        // Estado Global
        const appState = {
            tool: 'view',
            measurements: [],
            sectionState: {
                x: { enabled: false, value: 0, inverted: false },
                y: { enabled: false, value: 0, inverted: false }, 
                z: { enabled: false, value: 0, inverted: false }, 
                custom: { enabled: false, value: 0, inverted: false },
                bounds: { min: -20, max: 20 }
            },
            tempMeasurePoint: null
        };

        // Variables Three.js
        let camera, scene, renderer, controls;
        let modelsGroup, measureGroup, helpersGroup;
        let raycaster, mouse;
        let ifcLoaderInstance;
        let selectionBox = null, ifcSubset = null;
        let measureMarker;

        function initThreeJS() {
            clippingPlanes = [
                new THREE.Plane(new THREE.Vector3(-1, 0, 0), 0),
                new THREE.Plane(new THREE.Vector3(0, 0, -1), 0), 
                new THREE.Plane(new THREE.Vector3(0, -1, 0), 0),
                new THREE.Plane(new THREE.Vector3(0, -1, 0), 0)
            ];

            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(20, 20, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.localClippingEnabled = true;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            const ambient = new THREE.AmbientLight(0xffffff, 0.7);
            const dir1 = new THREE.DirectionalLight(0xffffff, 0.8);
            dir1.position.set(10, 20, 10);
            const dir2 = new THREE.DirectionalLight(0xffffff, 0.3);
            dir2.position.set(-10, 10, -10);
            scene.add(ambient, dir1, dir2);

            modelsGroup = new THREE.Group();
            measureGroup = new THREE.Group();
            helpersGroup = new THREE.Group();
            scene.add(modelsGroup, measureGroup, helpersGroup);
            scene.add(new THREE.GridHelper(50, 50, 0x333333, 0x222222));

            const mGeo = new THREE.SphereGeometry(0.2, 16, 16);
            const mMat = new THREE.MeshBasicMaterial({ color: 0xff0000, depthTest: false, transparent: true, opacity: 0.8 });
            measureMarker = new THREE.Mesh(mGeo, mMat);
            measureMarker.visible = false;
            measureMarker.renderOrder = 999;
            scene.add(measureMarker);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize);
            
            let isDragging = false;
            container.addEventListener('pointerdown', () => { isDragging = false; });
            container.addEventListener('pointermove', () => { isDragging = true; });
            container.addEventListener('pointerup', (e) => {
                if (!isDragging) onCanvasClick(e);
            });

            animate();
            setTool('view');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --------------------------------------------------------------------------------
        // CARGA DE ARCHIVOS
        // --------------------------------------------------------------------------------

        async function loadIFCFile(url, filename) {
            const loadingBar = document.getElementById('loading-bar');
            const errorMsg = document.getElementById('error-msg');
            
            loadingBar.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            statusBar.innerText = "Procesando archivo IFC...";
            clearScene();

            try {
                if (!ifcLoaderInstance) {
                    ifcLoaderInstance = new IFCLoader();
                    // IMPORTANTE: Ruta al WASM en UNPKG (más fiable que esm.sh para assets binarios)
                    await ifcLoaderInstance.ifcManager.setWasmPath('https://unpkg.com/web-ifc@0.0.44/');
                }

                // REMOVED applyWebIFCConfig call to prevent errors in certain versions

                ifcLoaderInstance.load(url, 
                    (model) => {
                        model.isIFCModel = true;
                        model.name = filename;
                        modelsGroup.add(model);
                        
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        const limit = Math.ceil(maxDim / 2) + 5;
                        appState.sectionState.bounds = { min: -limit, max: limit };
                        updateSectionUI();

                        controls.target.copy(center);
                        camera.position.copy(center).add(new THREE.Vector3(maxDim, maxDim/2, maxDim));
                        controls.update();

                        loadingBar.classList.add('hidden');
                        statusBar.innerText = "Modelo cargado con éxito.";
                    },
                    (progress) => {},
                    (err) => {
                        logDebug(err, true);
                        loadingBar.classList.add('hidden');
                        errorMsg.innerText = "Error leyendo IFC: " + err.message;
                        errorMsg.classList.remove('hidden');
                        statusBar.innerText = "Error de carga";
                    }
                );

            } catch (e) {
                logDebug(e, true);
                loadingBar.classList.add('hidden');
            }
        }

        function loadDemoModel() {
            clearScene();
            statusBar.innerText = "Generando modelo demo...";
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x3b82f6, side: THREE.DoubleSide });
            
            for(let i=0; i<20; i++) {
                const w = 0.5 + Math.random();
                const h = 2 + Math.random();
                const l = 0.5 + Math.random();
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,l), mat.clone());
                mesh.position.set((Math.random()-0.5)*15, h/2, (Math.random()-0.5)*15);
                mesh.rotation.y = Math.random() * Math.PI;
                mesh.material.color.setHSL(Math.random(), 0.6, 0.5);
                mesh.name = `Muro Demo ${i}`;
                mesh.userData = { Tipo: "Estructural", Lote: "A-"+i };
                mesh.updateMatrixWorld();
                modelsGroup.add(mesh);
            }
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(30,30), new THREE.MeshStandardMaterial({color: 0x222222, side: THREE.DoubleSide}));
            floor.rotation.x = -Math.PI/2;
            floor.name = "Suelo";
            modelsGroup.add(floor);

            appState.sectionState.bounds = { min: -15, max: 15 };
            updateSectionUI();
            statusBar.innerText = "Modelo Demo cargado.";
        }

        function clearScene() {
            while(modelsGroup.children.length) {
                const obj = modelsGroup.children[0];
                if(obj.geometry) obj.geometry.dispose();
                modelsGroup.remove(obj);
            }
            while(measureGroup.children.length) measureGroup.remove(measureGroup.children[0]);
            clearSelection();
            appState.measurements = [];
            renderMeasurements();
        }

        // --------------------------------------------------------------------------------
        // LÓGICA DE HERRAMIENTAS
        // --------------------------------------------------------------------------------

        function setTool(toolName) {
            appState.tool = toolName;
            
            document.querySelectorAll('.tool-btn').forEach(btn => {
                const isSelected = btn.dataset.tool === toolName;
                if (isSelected) {
                    if (toolName === 'surface-cut') {
                        btn.className = "tool-btn bg-yellow-600/30 text-yellow-400 border border-yellow-600/50 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform";
                    } else {
                        btn.className = "tool-btn bg-blue-600/30 text-blue-400 border border-blue-600/50 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform";
                    }
                } else {
                    btn.className = "tool-btn bg-neutral-700 text-gray-400 py-3 px-1 rounded flex flex-col items-center gap-1 active:scale-95 transition-transform";
                }
            });

            document.getElementById('sections-panel').classList.add('hidden');
            if (toolName === 'section' || toolName === 'surface-cut') {
                document.getElementById('sections-panel').classList.remove('hidden');
                updateSectionUI();
            } else if (toolName !== 'select') {
                document.getElementById('properties-panel').classList.add('hidden');
                clearSelection();
            }

            const texts = {
                'view': "Modo Navegación: Arrastra para rotar",
                'select': "Toca un objeto para ver sus datos",
                'measure': "Toca dos puntos para medir distancia",
                'section': "Usa los controles para cortar el modelo",
                'surface-cut': "Toca una cara plana para alinear el corte"
            };
            document.getElementById('tool-instruction').innerText = texts[toolName];
            
            if (window.innerWidth < 1024 && toolName !== 'section') {
                document.getElementById('sidebar').classList.add('closed');
            }

            updateClipping();
        }

        function onCanvasClick(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(modelsGroup.children, true)
                .filter(res => res.object.visible && res.object !== ifcSubset);

            const hit = intersects[0];

            if (appState.tool === 'surface-cut') {
                if (hit) {
                    const normal = hit.face.normal.clone().transformDirection(hit.object.matrixWorld).normalize();
                    const constant = -hit.point.dot(normal);
                    
                    clippingPlanes[3].normal.copy(normal);
                    clippingPlanes[3].constant = constant;
                    
                    appState.sectionState.custom.enabled = true;
                    appState.sectionState.custom.value = constant;
                    
                    updateSectionUI();
                    updateClipping();
                    statusBar.innerText = "Plano alineado a superficie";
                }
                return;
            }

            if (appState.tool === 'select') {
                if (hit) handleSelection(hit);
                else clearSelection();
                return;
            }

            if (appState.tool === 'measure') {
                if (hit) handleMeasureClick(hit.point);
                return;
            }
        }

        function handleSelection(hit) {
            clearSelection();
            const obj = hit.object;
            
            let data = { name: "Objeto", type: "Mesh", id: obj.uuid, props: obj.userData, dims: null };

            if (obj.isIFCModel) {
                const id = ifcLoaderInstance.ifcManager.getExpressId(obj.geometry, hit.faceIndex);
                if (id === undefined) return;

                ifcLoaderInstance.ifcManager.createSubset({
                    modelID: obj.modelID,
                    ids: [id],
                    material: new THREE.MeshBasicMaterial({ color: 0xffff00, depthTest: false, opacity: 0.5, transparent: true, side: THREE.DoubleSide }),
                    scene: scene,
                    removePrevious: true,
                    customID: 'select-subset'
                }).then(subset => {
                    ifcSubset = subset;
                    updateClipping();
                    
                    ifcLoaderInstance.ifcManager.getItemProperties(obj.modelID, id).then(props => {
                        const dims = calculateGeoDimensions(subset.geometry);
                        displayProperties({
                            id: id,
                            name: props.Name?.value || "Elemento IFC",
                            type: props.constructor.name.replace('IFC', ''),
                            dims: dims,
                            props: props
                        });
                    });
                });

            } else {
                selectionBox = new THREE.BoxHelper(obj, 0xffff00);
                scene.add(selectionBox);
                const geo = obj.geometry.clone().applyMatrix4(obj.matrixWorld);
                const dims = calculateGeoDimensions(geo);
                displayProperties({
                    id: obj.uuid.substring(0,8),
                    name: obj.name,
                    type: "Mesh",
                    dims: dims,
                    props: obj.userData
                });
            }
        }

        function handleMeasureClick(point) {
            if (!appState.tempMeasurePoint) {
                appState.tempMeasurePoint = point;
                measureMarker.position.copy(point);
                measureMarker.visible = true;
                statusBar.innerText = "Punto 1 marcado. Toca el punto final.";
            } else {
                const p1 = appState.tempMeasurePoint;
                const p2 = point;
                const dist = p1.distanceTo(p2);
                const id = Date.now();
                appState.measurements.push({ id, dist });
                
                const mat = new THREE.LineBasicMaterial({ color: 0x00ff00, depthTest: false });
                const geo = new THREE.BufferGeometry().setFromPoints([p1, p2]);
                const line = new THREE.Line(geo, mat);
                line.name = `m_${id}`;
                
                const sGeo = new THREE.SphereGeometry(0.05);
                const sMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const s1 = new THREE.Mesh(sGeo, sMat); s1.position.copy(p1); s1.name = `m_${id}_a`;
                const s2 = new THREE.Mesh(sGeo, sMat); s2.position.copy(p2); s2.name = `m_${id}_b`;
                
                measureGroup.add(line, s1, s2);
                appState.tempMeasurePoint = null;
                measureMarker.visible = false;
                renderMeasurements();
                statusBar.innerText = `Distancia: ${dist.toFixed(3)}m`;
            }
        }

        function clearSelection() {
            if(selectionBox) { scene.remove(selectionBox); selectionBox = null; }
            if(ifcSubset) { scene.remove(ifcSubset); ifcSubset.geometry.dispose(); ifcSubset = null; }
            document.getElementById('properties-panel').classList.add('hidden');
        }

        // --------------------------------------------------------------------------------
        // CÁLCULOS Y UI HELPERS
        // --------------------------------------------------------------------------------

        function calculateGeoDimensions(geometry) {
            geometry.computeBoundingBox();
            const b = geometry.boundingBox;
            const w = b.max.x - b.min.x;
            const h = b.max.y - b.min.y;
            const d = b.max.z - b.min.z;
            return { x: w, y: d, z: h, vol: w*h*d };
        }

        function displayProperties(data) {
            const p = document.getElementById('properties-panel');
            p.classList.remove('hidden');
            
            document.getElementById('props-basic').innerHTML = `
                <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Nombre:</span> <span class="text-white text-right truncate pl-2">${data.name}</span></div>
                <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Tipo:</span> <span class="text-blue-400 text-right">${data.type}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">ID:</span> <span class="text-gray-400 font-mono text-right">${data.id}</span></div>
            `;

            document.getElementById('props-quantities').innerHTML = `
                <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Ancho (X):</span> <span>${data.dims.x.toFixed(2)}m</span></div>
                <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Largo (Y):</span> <span>${data.dims.y.toFixed(2)}m</span></div>
                <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Alto (Z):</span> <span>${data.dims.z.toFixed(2)}m</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Volumen:</span> <span>${data.dims.vol.toFixed(3)}m³</span></div>
            `;

            document.getElementById('props-raw').innerText = JSON.stringify(data.props, null, 2);
            if(window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('closed');
        }

        function renderMeasurements() {
            const list = document.getElementById('measure-list');
            list.innerHTML = '';
            if(appState.measurements.length === 0) {
                document.getElementById('measure-panel').classList.add('hidden');
                return;
            }
            document.getElementById('measure-panel').classList.remove('hidden');
            
            appState.measurements.forEach(m => {
                const li = document.createElement('li');
                li.className = "bg-neutral-900/50 p-2 rounded flex justify-between items-center border-l-2 border-green-500 text-xs";
                li.innerHTML = `<span class="font-mono text-green-300">${m.dist.toFixed(3)}m</span>`;
                const btn = document.createElement('button');
                btn.innerHTML = "&times;";
                btn.className = "text-gray-500 hover:text-red-400 text-lg leading-none px-2";
                btn.onclick = () => {
                    appState.measurements = appState.measurements.filter(x => x.id !== m.id);
                    const group = measureGroup.children.filter(c => c.name.includes(m.id));
                    group.forEach(g => measureGroup.remove(g));
                    renderMeasurements();
                };
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function updateClipping() {
            const isSection = appState.tool === 'section' || appState.tool === 'surface-cut';
            const s = appState.sectionState;
            while(helpersGroup.children.length) helpersGroup.remove(helpersGroup.children[0]);
            
            const activePlanes = [];
            const helperSize = 30;

            if(isSection) {
                if(s.x.enabled) {
                    clippingPlanes[0].constant = s.x.value * (s.x.inverted ? -1 : 1);
                    clippingPlanes[0].normal.set(s.x.inverted ? 1 : -1, 0, 0);
                    activePlanes.push(clippingPlanes[0]);
                    helpersGroup.add(new THREE.PlaneHelper(clippingPlanes[0], helperSize, 0x3b82f6));
                }
                if(s.y.enabled) {
                    clippingPlanes[1].constant = s.y.value * (s.y.inverted ? -1 : 1);
                    clippingPlanes[1].normal.set(0, 0, s.y.inverted ? 1 : -1);
                    activePlanes.push(clippingPlanes[1]);
                    helpersGroup.add(new THREE.PlaneHelper(clippingPlanes[1], helperSize, 0x22c55e));
                }
                if(s.z.enabled) {
                    clippingPlanes[2].constant = s.z.value * (s.z.inverted ? -1 : 1);
                    clippingPlanes[2].normal.set(0, s.z.inverted ? 1 : -1, 0);
                    activePlanes.push(clippingPlanes[2]);
                    helpersGroup.add(new THREE.PlaneHelper(clippingPlanes[2], helperSize, 0xef4444));
                }
                if(s.custom.enabled) {
                    clippingPlanes[3].constant = s.custom.value * (s.custom.inverted ? -1 : 1);
                    activePlanes.push(clippingPlanes[3]);
                    helpersGroup.add(new THREE.PlaneHelper(clippingPlanes[3], helperSize, 0xeab308));
                }
            }

            renderer.localClippingEnabled = activePlanes.length > 0;
            const applyMat = (mat) => {
                mat.clippingPlanes = activePlanes;
                mat.clipShadows = true;
                mat.side = THREE.DoubleSide; 
                mat.needsUpdate = true;
            };

            modelsGroup.traverse(obj => {
                if(obj.isMesh) {
                    if(Array.isArray(obj.material)) obj.material.forEach(applyMat);
                    else applyMat(obj.material);
                }
            });
            if(ifcSubset) applyMat(ifcSubset.material);
        }

        function updateSectionUI() {
            const container = document.getElementById('sections-controls');
            container.innerHTML = ''; 
            
            const createSlider = (key, label, color) => {
                const div = document.createElement('div');
                div.className = "space-y-1";
                const row = document.createElement('div');
                row.className = "flex justify-between items-center text-xs";
                
                const labelEl = document.createElement('label');
                labelEl.className = "flex items-center gap-2 cursor-pointer";
                const check = document.createElement('input');
                check.type = 'checkbox';
                check.checked = appState.sectionState[key].enabled;
                check.className = `rounded bg-neutral-600 border-neutral-500 text-${color}-500 focus:ring-0`;
                check.onchange = (e) => {
                    appState.sectionState[key].enabled = e.target.checked;
                    updateClipping();
                    updateSectionUI();
                };
                
                const span = document.createElement('span');
                span.innerText = label;
                span.className = "text-gray-300 font-bold";
                labelEl.append(check, span);
                
                const invBtn = document.createElement('button');
                invBtn.innerHTML = "⇄";
                invBtn.className = `p-1 px-2 rounded bg-neutral-800 text-gray-400 ${appState.sectionState[key].inverted ? 'text-white bg-'+color+'-600' : ''}`;
                invBtn.onclick = () => {
                    appState.sectionState[key].inverted = !appState.sectionState[key].inverted;
                    updateClipping();
                    updateSectionUI();
                };

                row.append(labelEl, invBtn);
                
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = appState.sectionState.bounds.min;
                slider.max = appState.sectionState.bounds.max;
                slider.step = 0.1;
                slider.value = appState.sectionState[key].value;
                slider.className = `w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-${color}-500`;
                slider.disabled = !appState.sectionState[key].enabled;
                if(slider.disabled) slider.style.opacity = 0.5;
                
                slider.oninput = (e) => {
                    appState.sectionState[key].value = parseFloat(e.target.value);
                    updateClipping();
                };

                div.append(row, slider);
                return div;
            };

            container.appendChild(createSlider('x', 'Corte X', 'blue'));
            container.appendChild(createSlider('y', 'Corte Y (Largo)', 'green'));
            container.appendChild(createSlider('z', 'Corte Z (Alto)', 'red'));
            container.appendChild(createSlider('custom', 'Corte Custom', 'yellow'));
        }

        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.onclick = () => setTool(btn.dataset.tool);
        });
        document.getElementById('menu-btn').onclick = () => document.getElementById('sidebar').classList.remove('closed');
        document.getElementById('close-sidebar').onclick = () => document.getElementById('sidebar').classList.add('closed');
        document.getElementById('clear-selection').onclick = clearSelection;
        document.getElementById('clear-measures').onclick = () => {
            appState.measurements = [];
            while(measureGroup.children.length) measureGroup.remove(measureGroup.children[0]);
            renderMeasurements();
        };
        document.getElementById('file-input').onchange = (e) => {
            if(e.target.files[0]) loadIFCFile(URL.createObjectURL(e.target.files[0]), e.target.files[0].name);
        };
        document.getElementById('load-demo').onclick = loadDemoModel;

        initApp();

    </script>
</body>
</html>
