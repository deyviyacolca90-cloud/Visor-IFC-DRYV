<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor IFC - DRYV</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map para gestionar dependencias de forma robusta -->
    <!-- FIX: Agregado mapeo para 'three/examples/' para resolver BufferGeometryUtils -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js",
                "three/examples/": "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/",
                "web-ifc-three": "https://unpkg.com/web-ifc-three@0.0.126/IFCLoader.js",
                "web-ifc": "https://unpkg.com/web-ifc@0.0.44/web-ifc-api.js"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #171717; color: #f3f4f6; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        .sidebar { z-index: 10; transition: transform 0.3s ease; }
        .sidebar.closed { transform: translateX(-100%); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #262626; }
        ::-webkit-scrollbar-thumb { background: #404040; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #525252; }
        .cursor-crosshair { cursor: crosshair; }
        .cursor-help { cursor: help; }
        .cursor-default { cursor: default; }
    </style>
</head>
<body>

    <!-- UI Overlay -->
    <div id="app-ui" class="absolute inset-0 pointer-events-none z-10 flex flex-col h-full">
        
        <!-- Sidebar Toggle (Mobile) -->
        <button id="menu-btn" class="pointer-events-auto absolute top-4 left-4 z-50 bg-neutral-800 p-2 rounded text-white shadow-lg lg:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        </button>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar pointer-events-auto bg-neutral-800 border-r border-neutral-700 w-[85vw] sm:w-80 h-full flex flex-col absolute lg:relative">
            <!-- Header -->
            <div class="p-4 border-b border-neutral-700 flex justify-between items-center">
                <h1 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16.02 12 5.48 3.13a1 1 0 0 1 .49.87v5a1 1 0 0 1-1 1h-16a1 1 0 0 1-1-1v-5a1 1 0 0 1 .49-.87l5.48-3.13"/><path d="M16 12V7a4 4 0 0 0-8 0v5"/><path d="M12 21v-9"/></svg>
                    Visor IFC - DRYV
                </h1>
                <button id="close-sidebar" class="lg:hidden p-1 hover:bg-neutral-700 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                
                <!-- Sección Modelo -->
                <div class="space-y-3">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Modelo</h2>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded flex items-center justify-center gap-2 transition-colors text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span>Cargar .IFC</span>
                            <input type="file" id="file-input" accept=".ifc" class="hidden" />
                        </label>
                    </div>
                    <button id="load-demo" class="w-full bg-neutral-700 hover:bg-neutral-600 text-gray-200 py-2 rounded flex items-center justify-center gap-2 text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                        Cargar Demo
                    </button>
                    <div id="loading-msg" class="hidden text-yellow-400 text-xs animate-pulse">Procesando geometría...</div>
                    <div id="error-msg" class="hidden text-amber-400 text-xs bg-amber-900/20 p-2 rounded border border-amber-800/50 break-words"></div>
                </div>

                <hr class="border-neutral-700" />

                <!-- Herramientas -->
                <div class="space-y-3">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Herramientas</h2>
                    <div class="grid grid-cols-5 gap-1">
                        <!-- Botones -->
                        <button class="tool-btn bg-blue-600/20 text-blue-400 border border-blue-600/50 py-3 px-1 rounded flex flex-col items-center gap-1" data-tool="view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/></svg>
                            <span class="text-[9px]">Nav</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-300 py-3 px-1 rounded flex flex-col items-center gap-1" data-tool="select">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <span class="text-[9px]">Info</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-300 py-3 px-1 rounded flex flex-col items-center gap-1" data-tool="measure">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>
                            <span class="text-[9px]">Medir</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-300 py-3 px-1 rounded flex flex-col items-center gap-1" data-tool="section">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>
                            <span class="text-[9px]">Cortar</span>
                        </button>
                        <button class="tool-btn bg-neutral-700 text-gray-300 py-3 px-1 rounded flex flex-col items-center gap-1" data-tool="surface-cut">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg>
                            <span class="text-[9px]">Cara</span>
                        </button>
                    </div>
                    <div id="tool-instruction" class="text-xs text-gray-400 bg-neutral-900/50 p-2 rounded border border-neutral-700 text-center italic">
                        Arrastra para rotar.
                    </div>
                </div>

                <hr class="border-neutral-700" />

                <!-- PANEL PROPIEDADES (Info) -->
                <div id="properties-panel" class="hidden space-y-3 animate-in fade-in slide-in-from-right-4 duration-300">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-semibold text-green-400 uppercase tracking-wider flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg> 
                            Propiedades
                        </h2>
                        <button id="clear-selection" class="hover:text-white text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                    <div id="props-basic" class="bg-neutral-700/30 rounded p-3 text-xs space-y-2 font-mono border border-neutral-700">
                        <!-- Content injected by JS -->
                    </div>
                    <div class="space-y-1">
                        <h3 class="text-xs font-semibold text-yellow-500 uppercase flex items-center gap-1 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
                            Dimensiones <span id="dim-method" class="text-gray-500 text-[10px] ml-auto"></span>
                        </h3>
                        <div id="props-quantities" class="bg-neutral-700/30 rounded p-3 text-xs space-y-2 font-mono border border-neutral-700">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                    <div class="space-y-1 mt-2">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Atributos Raw</h3>
                        <div id="props-raw" class="bg-neutral-900/50 rounded p-2 text-[10px] font-mono max-h-32 overflow-auto text-gray-400 whitespace-pre-wrap"></div>
                    </div>
                </div>

                <!-- PANEL SECCIONES -->
                <div id="sections-panel" class="hidden space-y-3 animate-in fade-in slide-in-from-right-4 duration-300">
                    <h2 class="text-sm font-semibold text-yellow-500 uppercase tracking-wider flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>
                        Planos de Corte
                    </h2>
                    <div id="sections-controls" class="bg-neutral-700/30 rounded p-3 space-y-4 border border-neutral-700">
                        <!-- Controls generated by JS -->
                    </div>
                </div>

                <!-- LISTA MEDICIONES -->
                <div id="measure-panel" class="hidden space-y-3">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Mediciones</h2>
                        <button id="clear-measures" class="text-xs text-red-400 hover:text-red-300">Borrar todo</button>
                    </div>
                    <ul id="measure-list" class="space-y-1"></ul>
                </div>

            </div>
            
            <div class="p-3 border-t border-neutral-700 text-[10px] text-neutral-600 text-center">
                Three.js v0.155 &bull; web-ifc-three
            </div>
        </div>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Overlay inferior flotante -->
    <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-neutral-800/90 backdrop-blur px-4 py-2 rounded-full text-xs text-gray-300 border border-white/10 shadow-xl pointer-events-none whitespace-nowrap z-20">
        <span id="status-bar">Iniciando motor gráfico...</span>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // IMPORTACIONES ESTÁTICAS DESDE IMPORT MAP
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { IFCLoader } from 'web-ifc-three';

        // Configuración Global
        const appState = {
            tool: 'view',
            measurements: [],
            sectionState: {
                x: { enabled: false, value: 0, inverted: false },
                y: { enabled: false, value: 0, inverted: false },
                z: { enabled: false, value: 0, inverted: false },
                custom: { enabled: false, value: 0, inverted: false },
                bounds: { min: -20, max: 20 }
            },
            tempMeasurePoint: null
        };

        // Referencias Three.js
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 20, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.localClippingEnabled = true; 
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Luces
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);
        scene.add(new THREE.DirectionalLight(0xffffff, 0.3).translateY(5).translateX(-5));

        // Grupos
        const modelsGroup = new THREE.Group();
        const measureGroup = new THREE.Group();
        const helpersGroup = new THREE.Group();
        scene.add(modelsGroup, measureGroup, helpersGroup);

        // Grid
        scene.add(new THREE.GridHelper(50, 50, 0x444444, 0x2a2a2a));

        // Helpers visuales
        const markerGeo = new THREE.SphereGeometry(0.15, 16, 16);
        const markerMat = new THREE.MeshBasicMaterial({ color: 0xff0000, depthTest: false, transparent: true });
        const measureMarker = new THREE.Mesh(markerGeo, markerMat);
        measureMarker.visible = false;
        measureMarker.renderOrder = 999;
        scene.add(measureMarker);

        let selectionBox = null;
        let ifcSubset = null;
        let ifcLoaderInstance = null;

        // Planos de corte
        const planes = [
            new THREE.Plane(new THREE.Vector3(-1, 0, 0), 0), // X
            new THREE.Plane(new THREE.Vector3(0, 0, -1), 0), // Y (Visual Z)
            new THREE.Plane(new THREE.Vector3(0, -1, 0), 0), // Z (Visual Y)
            new THREE.Plane(new THREE.Vector3(0, -1, 0), 0)  // Custom
        ];

        // Raycaster
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // ------------------------------------------------------------------
        // LÓGICA DE GEOMETRÍA
        // ------------------------------------------------------------------
        
        function calculateDimensions(geometry) {
            const pos = geometry.attributes.position;
            const idx = geometry.index;
            const points = [];
            let minY = Infinity, maxY = -Infinity;
            const count = idx ? idx.count : pos.count;

            for(let i=0; i<count; i++) {
                const index = idx ? idx.getX(i) : i;
                const x = pos.getX(index);
                const y = pos.getY(index);
                const z = pos.getZ(index);
                if(y < minY) minY = y;
                if(y > maxY) maxY = y;
                points.push({x, y: z}); // Proyección XZ
            }
            const height = (maxY > minY) ? (maxY - minY) : 0;

            // Convex Hull 2D (Monotone Chain)
            points.sort((a,b) => a.x === b.x ? a.y - b.y : a.x - b.x);
            const cross = (o, a, b) => (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x);
            const lower = [];
            for(let p of points){
                while(lower.length >= 2 && cross(lower[lower.length-2], lower[lower.length-1], p) <= 0) lower.pop();
                lower.push(p);
            }
            const upper = [];
            for(let i=points.length-1; i>=0; i--){
                const p = points[i];
                while(upper.length >= 2 && cross(upper[upper.length-2], upper[upper.length-1], p) <= 0) upper.pop();
                upper.push(p);
            }
            upper.pop(); lower.pop();
            const hull = lower.concat(upper);

            // Rotating Calipers
            let minW = Infinity, minL = Infinity;
            if(hull.length < 3) {
                let minX=Infinity, maxX=-Infinity, minZ=Infinity, maxZ=-Infinity;
                points.forEach(p => {
                    minX=Math.min(minX, p.x); maxX=Math.max(maxX, p.x);
                    minZ=Math.min(minZ, p.y); maxZ=Math.max(maxZ, p.y);
                });
                minW = maxX - minX; minL = maxZ - minZ;
            } else {
                let minArea = Infinity;
                for(let i=0; i<hull.length; i++) {
                    const p1 = hull[i];
                    const p2 = hull[(i+1)%hull.length];
                    const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                    let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
                    const c = Math.cos(-angle), s = Math.sin(-angle);
                    for(let p of hull) {
                        const rx = p.x*c - p.y*s;
                        const ry = p.x*s + p.y*c;
                        minX=Math.min(minX, rx); maxX=Math.max(maxX, rx);
                        minY=Math.min(minY, ry); maxY=Math.max(maxY, ry);
                    }
                    const w = maxX - minX; const h = maxY - minY;
                    if(w*h < minArea) { minArea = w*h; minW = w; minL = h; }
                }
            }

            return {
                x: Math.min(minW, minL),
                y: Math.max(minW, minL),
                z: height,
                vol: Math.min(minW, minL) * Math.max(minW, minL) * height
            };
        }

        // ------------------------------------------------------------------
        // FUNCIONES CORE
        // ------------------------------------------------------------------

        function updateClipping() {
            const activePlanes = [];
            const helperSize = (appState.sectionState.bounds.max * 2) || 20;
            
            while(helpersGroup.children.length) helpersGroup.remove(helpersGroup.children[0]);

            const isSectionMode = appState.tool === 'section' || appState.tool === 'surface-cut';

            if (isSectionMode) {
                const s = appState.sectionState;
                if (s.x.enabled) {
                    planes[0].normal.set(s.x.inverted ? 1 : -1, 0, 0);
                    planes[0].constant = s.x.value;
                    activePlanes.push(planes[0]);
                    helpersGroup.add(new THREE.PlaneHelper(planes[0], helperSize, 0x0000ff));
                }
                if (s.y.enabled) { // Eje Y (Visual Z)
                    planes[1].normal.set(0, 0, s.y.inverted ? 1 : -1);
                    planes[1].constant = s.y.value;
                    activePlanes.push(planes[1]);
                    helpersGroup.add(new THREE.PlaneHelper(planes[1], helperSize, 0x00ff00));
                }
                if (s.z.enabled) { // Eje Z (Visual Y)
                    planes[2].normal.set(0, s.z.inverted ? 1 : -1, 0);
                    planes[2].constant = s.z.value;
                    activePlanes.push(planes[2]);
                    helpersGroup.add(new THREE.PlaneHelper(planes[2], helperSize, 0xff0000));
                }
                if (s.custom.enabled) {
                    planes[3].constant = s.custom.value * (s.custom.inverted ? -1 : 1);
                    activePlanes.push(planes[3]);
                    helpersGroup.add(new THREE.PlaneHelper(planes[3], helperSize, 0xffff00));
                }
            }

            // Aplicar a materiales
            const apply = (obj) => {
                if (obj.material) {
                    const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
                    mats.forEach(m => {
                        m.clippingPlanes = activePlanes.length ? activePlanes : null;
                        m.clipShadows = true;
                        m.side = THREE.DoubleSide; // Forzar double side siempre para mejor visualización
                        m.needsUpdate = true;
                    });
                }
            };
            modelsGroup.traverse(child => { if(child.isMesh) apply(child); });
            if (ifcSubset) apply(ifcSubset);
        }

        async function loadIFC(url, name) {
            const errorDiv = document.getElementById('error-msg');
            const loadingDiv = document.getElementById('loading-msg');
            
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            clearScene();
            
            try {
                if (!ifcLoaderInstance) {
                    ifcLoaderInstance = new IFCLoader();
                    // IMPORTANTE: Ruta al archivo WASM compatible
                    await ifcLoaderInstance.ifcManager.setWasmPath('https://unpkg.com/web-ifc@0.0.44/');
                }
                
                ifcLoaderInstance.load(url, (model) => {
                    model.isIFCModel = true;
                    model.name = name;
                    modelsGroup.add(model);
                    
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    
                    controls.target.copy(center);
                    camera.position.copy(center).add(new THREE.Vector3(maxDim, maxDim, maxDim));
                    controls.update();

                    const limit = Math.ceil(maxDim / 2) + 2;
                    appState.sectionState.bounds = { min: -limit, max: limit };
                    updateSectionUI();

                    loadingDiv.classList.add('hidden');
                }, 
                (progress) => console.log('Cargando...', progress),
                (err) => {
                    console.error(err);
                    loadingDiv.classList.add('hidden');
                    errorDiv.innerText = "Error cargando archivo. Verifica tu conexión a internet o intenta con otro archivo.";
                    errorDiv.classList.remove('hidden');
                });

            } catch(e) {
                console.error(e);
                loadingDiv.classList.add('hidden');
                errorDiv.innerText = "Error crítico: " + e.message + ". Intenta usar el botón Demo.";
                errorDiv.classList.remove('hidden');
            }
        }

        function loadDemo() {
            clearScene();
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x3b82f6, side: THREE.DoubleSide });
            const group = new THREE.Group();
            
            for(let i=0; i<15; i++) {
                const w = 0.2 + Math.random()*0.5;
                const l = 1.0 + Math.random()*2.0;
                const h = 0.5 + Math.random()*2.5;
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, l), mat.clone());
                mesh.material.color.setHSL(Math.random(), 0.5, 0.5);
                mesh.position.set((Math.random()-0.5)*10, h/2, (Math.random()-0.5)*10);
                mesh.rotation.y = Math.random() * Math.PI;
                mesh.updateMatrix();
                mesh.updateMatrixWorld();
                mesh.name = `Muro Demo #${i+1}`;
                mesh.userData = { tipo: "Muro", layer: "Estructura" };
                modelsGroup.add(mesh);
            }
            
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.MeshStandardMaterial({color: 0x333333, side: THREE.DoubleSide}));
            floor.rotation.x = -Math.PI/2;
            floor.name = "Suelo";
            modelsGroup.add(floor);
            
            appState.sectionState.bounds = { min: -10, max: 10 };
            updateSectionUI();
        }

        function clearScene() {
            while(modelsGroup.children.length) modelsGroup.remove(modelsGroup.children[0]);
            while(measureGroup.children.length) measureGroup.remove(measureGroup.children[0]);
            clearSelection();
            appState.measurements = [];
            renderMeasurements();
        }

        function clearSelection() {
            if(selectionBox) { scene.remove(selectionBox); selectionBox = null; }
            if(ifcSubset) { scene.remove(ifcSubset); ifcSubset.geometry.dispose(); ifcSubset = null; }
            document.getElementById('properties-panel').classList.add('hidden');
        }

        // ------------------------------------------------------------------
        // INTERACCIÓN
        // ------------------------------------------------------------------

        function onPointerClick(event) {
            if (controls.isDragging) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(modelsGroup.children, true)
                .filter(i => i.object.type === 'Mesh' && i.object !== ifcSubset);

            if (appState.tool === 'surface-cut' && intersects.length > 0) {
                const hit = intersects[0];
                const normal = hit.face.normal.clone().transformDirection(hit.object.matrixWorld).normalize();
                const constant = -hit.point.dot(normal);
                
                planes[3].normal.copy(normal);
                planes[3].constant = constant;
                
                appState.sectionState.custom.enabled = true;
                appState.sectionState.custom.value = constant;
                
                updateSectionUI();
                updateClipping();
                return;
            }

            if (appState.tool === 'select') {
                if (intersects.length > 0) {
                    selectObject(intersects[0]);
                } else {
                    clearSelection();
                }
            }

            if (appState.tool === 'measure') {
                if(intersects.length > 0) {
                    handleMeasure(intersects[0].point);
                }
            }
        }

        function selectObject(hit) {
            clearSelection();
            const object = hit.object;
            
            let data = { name: "Objeto", type: "Mesh", id: object.uuid, props: object.userData, dims: null };

            if (object.isIFCModel) {
                const index = hit.faceIndex;
                const id = ifcLoaderInstance.ifcManager.getExpressId(object.geometry, index);
                
                ifcLoaderInstance.ifcManager.createSubset({
                    modelID: object.modelID,
                    ids: [id],
                    material: new THREE.MeshBasicMaterial({ color: 0xffff00, depthTest: false, opacity: 0.6, transparent: true, side: THREE.DoubleSide }),
                    scene: scene,
                    removePrevious: true,
                    customID: 'selection-subset'
                }).then(subset => {
                    ifcSubset = subset;
                    
                    // Aplicar planos de corte al subset si están activos
                    updateClipping();

                    const dims = calculateDimensions(subset.geometry);
                    ifcLoaderInstance.ifcManager.getItemProperties(object.modelID, id).then(props => {
                        data.name = props.Name?.value || "Elemento IFC";
                        data.type = props.constructor.name.replace('IFC', '');
                        data.id = id;
                        data.props = props;
                        data.dims = dims;
                        showProperties(data);
                    });
                });
            } else {
                selectionBox = new THREE.BoxHelper(object, 0xffff00);
                scene.add(selectionBox);
                
                const geo = object.geometry.clone().applyMatrix4(object.matrixWorld);
                data.dims = calculateDimensions(geo);
                data.name = object.name;
                showProperties(data);
            }
        }

        function handleMeasure(point) {
            if (!appState.tempMeasurePoint) {
                appState.tempMeasurePoint = point;
                measureMarker.position.copy(point);
                measureMarker.visible = true;
                document.getElementById('status-bar').innerText = "Selecciona punto final";
            } else {
                const p1 = appState.tempMeasurePoint;
                const p2 = point;
                const dist = p1.distanceTo(p2);
                
                const id = Date.now().toString();
                appState.measurements.push({id, dist});
                
                const mat = new THREE.LineBasicMaterial({ color: 0x00ff00, depthTest: false });
                const geo = new THREE.BufferGeometry().setFromPoints([p1, p2]);
                const line = new THREE.Line(geo, mat);
                line.name = `m_${id}`;
                measureGroup.add(line);
                
                const sGeo = new THREE.SphereGeometry(0.05);
                const sMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const s1 = new THREE.Mesh(sGeo, sMat); s1.position.copy(p1); s1.name = `m_${id}_1`;
                const s2 = new THREE.Mesh(sGeo, sMat); s2.position.copy(p2); s2.name = `m_${id}_2`;
                measureGroup.add(s1, s2);

                appState.tempMeasurePoint = null;
                measureMarker.visible = false;
                renderMeasurements();
                document.getElementById('status-bar').innerText = "Medición añadida";
            }
        }

        // ------------------------------------------------------------------
        // UI UPDATES
        // ------------------------------------------------------------------

        function showProperties(data) {
            const panel = document.getElementById('properties-panel');
            panel.classList.remove('hidden');
            
            document.getElementById('props-basic').innerHTML = `
                <div class="grid grid-cols-[60px_1fr] gap-2 border-b border-white/10 pb-1">
                    <span class="text-gray-500">ID:</span> <span class="text-white truncate" title="${data.id}">${String(data.id).slice(0,10)}</span>
                </div>
                <div class="grid grid-cols-[60px_1fr] gap-2 border-b border-white/10 pb-1">
                    <span class="text-gray-500">Tipo:</span> <span class="text-blue-300">${data.type}</span>
                </div>
                <div class="mt-1"><span class="text-gray-300 block bg-neutral-800/50 p-1 rounded break-words">${data.name}</span></div>
            `;

            if(data.dims) {
                document.getElementById('dim-method').innerText = "(Geometría)";
                document.getElementById('props-quantities').innerHTML = `
                    <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Ancho (X):</span> <span>${data.dims.x.toFixed(3)} m</span></div>
                    <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Largo (Y):</span> <span>${data.dims.y.toFixed(3)} m</span></div>
                    <div class="flex justify-between border-b border-white/10 pb-1"><span class="text-gray-500">Alto (Z):</span> <span>${data.dims.z.toFixed(3)} m</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Volumen:</span> <span>${data.dims.vol.toFixed(3)} m³</span></div>
                `;
            }

            document.getElementById('props-raw').innerText = JSON.stringify(data.props, null, 2);
            
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('closed');
            }
        }

        function renderMeasurements() {
            const list = document.getElementById('measure-list');
            list.innerHTML = '';
            if (appState.measurements.length > 0) document.getElementById('measure-panel').classList.remove('hidden');
            else document.getElementById('measure-panel').classList.add('hidden');

            appState.measurements.forEach(m => {
                const li = document.createElement('li');
                li.className = 'bg-neutral-700/50 p-2 rounded flex justify-between items-center border-l-2 border-green-500';
                li.innerHTML = `<span class="font-mono text-sm">${m.dist.toFixed(3)}m</span>`;
                const btn = document.createElement('button');
                btn.className = 'text-neutral-500 hover:text-red-400';
                btn.innerHTML = '×';
                btn.onclick = () => {
                    const idx = appState.measurements.findIndex(x => x.id === m.id);
                    if (idx > -1) {
                        appState.measurements.splice(idx, 1);
                        const toRemove = measureGroup.children.filter(c => c.name.includes(m.id));
                        toRemove.forEach(c => measureGroup.remove(c));
                        renderMeasurements();
                    }
                };
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function updateSectionUI() {
            const s = appState.sectionState;
            const container = document.getElementById('sections-controls');
            
            const createControl = (axis, label, colorClass) => `
                <div class="space-y-1">
                   <div class="flex justify-between items-center text-xs">
                     <label class="flex items-center gap-2 cursor-pointer p-1">
                        <input type="checkbox" id="sec-en-${axis}" ${s[axis].enabled ? 'checked' : ''} class="rounded bg-neutral-600 border-neutral-500 text-${colorClass}-500"/>
                        <span class="text-gray-300 font-bold">${label}</span>
                     </label>
                     <button id="sec-inv-${axis}" class="p-2 hover:bg-neutral-600 rounded text-gray-400 ${s[axis].inverted ? `text-${colorClass}-400` : ''}" title="Invertir">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                     </button>
                   </div>
                   <input type="range" id="sec-val-${axis}" min="${s.bounds.min}" max="${s.bounds.max}" step="0.1" value="${s[axis].value}" ${!s[axis].enabled ? 'disabled' : ''} class="w-full accent-${colorClass}-500 h-4 bg-neutral-600 rounded-lg appearance-none cursor-pointer disabled:opacity-50"/>
                </div>
            `;

            container.innerHTML = 
                createControl('x', 'Corte X (Ancho)', 'blue') +
                createControl('y', 'Corte Y (Largo)', 'green') +
                createControl('z', 'Corte Z (Alto)', 'red') +
                createControl('custom', 'Plano Cara', 'yellow');

            ['x','y','z','custom'].forEach(axis => {
                document.getElementById(`sec-en-${axis}`).onchange = (e) => {
                    appState.sectionState[axis].enabled = e.target.checked;
                    updateClipping();
                    updateSectionUI();
                };
                document.getElementById(`sec-inv-${axis}`).onclick = () => {
                    appState.sectionState[axis].inverted = !appState.sectionState[axis].inverted;
                    updateClipping();
                    updateSectionUI();
                };
                document.getElementById(`sec-val-${axis}`).oninput = (e) => {
                    appState.sectionState[axis].value = parseFloat(e.target.value);
                    updateClipping();
                };
            });
        }

        // ------------------------------------------------------------------
        // EVENTOS DOM
        // ------------------------------------------------------------------

        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.tool-btn').forEach(b => {
                    b.classList.remove('bg-blue-600/20', 'text-blue-400', 'border', 'border-blue-600/50', 'bg-yellow-600/20', 'text-yellow-400', 'border-yellow-600/50');
                    b.classList.add('bg-neutral-700', 'text-gray-300');
                });
                
                const tool = btn.dataset.tool;
                appState.tool = tool;
                
                if (tool === 'surface-cut') {
                    btn.classList.remove('bg-neutral-700', 'text-gray-300');
                    btn.classList.add('bg-yellow-600/20', 'text-yellow-400', 'border', 'border-yellow-600/50');
                } else {
                    btn.classList.remove('bg-neutral-700', 'text-gray-300');
                    btn.classList.add('bg-blue-600/20', 'text-blue-400', 'border', 'border-blue-600/50');
                }

                document.getElementById('sections-panel').classList.add('hidden');
                document.getElementById('status-bar').innerText = tool === 'view' ? "Navegación libre" : `Modo: ${tool.toUpperCase()}`;

                if (tool === 'section' || tool === 'surface-cut') {
                    document.getElementById('sections-panel').classList.remove('hidden');
                    updateSectionUI();
                    updateClipping();
                } else {
                    updateClipping();
                }

                if (window.innerWidth < 1024 && tool !== 'section') {
                    document.getElementById('sidebar').classList.add('closed');
                }
            };
        });

        document.getElementById('menu-btn').onclick = () => document.getElementById('sidebar').classList.remove('closed');
        document.getElementById('close-sidebar').onclick = () => document.getElementById('sidebar').classList.add('closed');
        
        document.getElementById('load-demo').onclick = loadDemo;
        document.getElementById('file-input').onchange = (e) => {
            if(e.target.files[0]) loadIFC(URL.createObjectURL(e.target.files[0]), e.target.files[0].name);
        };
        
        document.getElementById('clear-selection').onclick = clearSelection;
        document.getElementById('clear-measures').onclick = () => {
            appState.measurements = [];
            while(measureGroup.children.length) measureGroup.remove(measureGroup.children[0]);
            renderMeasurements();
        };

        container.addEventListener('pointerdown', () => { window.isDragging = false; });
        container.addEventListener('pointermove', () => { window.isDragging = true; });
        container.addEventListener('pointerup', (e) => {
            if (!window.isDragging) onPointerClick(e);
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        document.getElementById('status-bar').innerText = "Listo. Carga un modelo.";
        
        // Iniciar en modo View
        document.querySelector('[data-tool="view"]').click();

    </script>
</body>
</html>